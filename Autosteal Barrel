local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace:FindFirstChild("Camera")
local Player = game:GetService('Players').LocalPlayer
local PlayerGui = Player.PlayerGui
local Character = Player.Character
local HumanoidRootPart = Character:FindFirstChild("HumanoidRootPart")
local KeyCode = Enum.KeyCode.X
local TrackedBarrels = {}
local UISConnection, AdorneeConnection
Character:FindFirstChild("Humanoid"):SetStateEnabled(0, false)

local function PressFOnPart(Part)
    local FArgs = {
        [1] = "f",
        [2] = Part
    }

    Player.Backpack.Input:FireServer(unpack(FArgs))
end

local function FindBarrelInTable(Barrel)
    for i, item in pairs(TrackedBarrels) do
        if (item == Barrel) then
            return item
        end
    end
end

local function StealBarrel(Barrel)
    local ReturnCFrame = HumanoidRootPart.CFrame
    local Locked = Barrel:FindFirstChild("Lock")
    if not Locked.Value then
        Camera.FieldOfView = 40
        local Connection
        Connection = RunService.Heartbeat:Connect(function()
            local TorsoWeld = Barrel:FindFirstChild("TorsoWeld")
            if (TorsoWeld.Part1 == nil) then
                if not Locked.Value then
                    HumanoidRootPart.CFrame = Barrel.Union.CFrame
                    Camera.CFrame = CFrame.new(Camera.CFrame.Position, Barrel.Union.Position)
                    PressFOnPart(Barrel)
                else
                    Connection:Disconnect()
                end
            else
                Camera.FieldOfView = 70
                Connection:Disconnect()
                HumanoidRootPart.CFrame = ReturnCFrame
            end
        end)
    end
end

local function DetectBarrel(Barrel)
    if Barrel:FindFirstChild("Lock") then
        local Lock = Barrel:FindFirstChild("Lock")
            local Connection
            Connection = Lock.Changed:Connect(function(Bool)
                local BarrelInTable = FindBarrelInTable(Barrel) 
                if BarrelInTable then
                    if not Bool then
                        StealBarrel(Barrel)
                    end
            else
                Connection:Disconnect()
            end
        end)
    end
end

local function CreateUIExtentsion()
    local BarrelUI = PlayerGui.BarrelMover
    local Frame = BarrelUI.Frame
    
    if BarrelUI and Frame then
        local Scale = Instance.new("UIScale", Frame)
        Scale.Scale = 0.8
        local UIListLayout = Instance.new("UIListLayout", Frame)
        local TextLabel = Frame:FindFirstChild("Nickname"):Clone()
        TextLabel.Name = "X"
        TextLabel.Text = "[X] Auto Steal"
        TextLabel.Parent = Frame
    end
end

--Created By Cronoaix

CreateUIExtentsion()

UISConnection = UserInputService.InputBegan:Connect(function(Input, Chat)
    local BarrelUI = PlayerGui.BarrelMover
    local Frame = BarrelUI.Frame
    if Input.KeyCode == KeyCode and not Chat then
        if BarrelUI.Adornee ~= nil then
            local Barrel = BarrelUI.Adornee
            local BarrelInTable = FindBarrelInTable(Barrel) 
            if BarrelInTable then
                table.remove(TrackedBarrels, table.find(TrackedBarrels, BarrelInTable))
                Frame.X.Text = "[X] Auto Steal"
            else
                table.insert(TrackedBarrels, Barrel)
                Frame.X.Text = "[X] UnAuto Steal"
                DetectBarrel(Barrel)
            end
        end
    end
end)

AdorneeConnection = PlayerGui.BarrelMover:GetPropertyChangedSignal("Adornee"):Connect(function()
    local BarrelUI = PlayerGui.BarrelMover
    local Frame = BarrelUI.Frame
    local Barrel = BarrelUI.Adornee
    local BarrelInTable = FindBarrelInTable(Barrel)
    if BarrelInTable ~= nil then
        Frame.X.Text = "[X] UnAuto Steal"
    elseif not BarrelInTable then
        if Barrel ~= nil and Barrel.Name == "Barrel" then
            Frame.X.Text = "[X] Auto Steal"
        end
    end
end)

Player.CharacterAdded:Connect(function(Character)
    local Humanoid = Character:WaitForChild("Humanoid", 5)
    if not Humanoid then
        return
    end
    
    Humanoid.Died:Connect(function()
        table.clear(TrackedBarrels)
        UISConnection:Disconnect()
        AdorneeConnection:Disconnect()
    end)
end)
